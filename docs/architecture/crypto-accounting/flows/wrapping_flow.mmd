sequenceDiagram
    autonumber
    actor User
    participant UI as Transfer/Wrap UI
    participant Handler as Transformation Engine
    participant DB as crypto_acquisition Table

    Note over User, DB: Scenario: Wrapping ETH to WETH (Transformation)

    User->>UI: Selects "Transfer/Wrap" Tab
    User->>UI: From: Wallet A, To: Wallet A (Same location)
    User->>UI: Source Asset: ETH
    User->>UI: Destination Asset: WETH
    User->>UI: Amount: 1.0
    User->>UI: Checkbox: "Treat as Non-Taxable Transformation" (Checked)
    
    UI->>Handler: ExecuteTransformation(FromAsset: ETH, ToAsset: WETH, Amount: 1.0)
    
    Note right of Handler: Step 1: Find Source Lot (FIFO)
    Handler->>DB: SELECT * FROM crypto_acquisition <br/>WHERE asset='ETH' AND remaining > 0
    DB-->>Handler: Returns Lot Old (Bought 2 years ago @ $500)
    
    Note right of Handler: Step 2: Close Source
    Handler->>DB: UPDATE Lot Old SET amount_remaining = 0
    
    Note right of Handler: Step 3: Create Wrapped Lot (Rollover)
    Note right of Handler: CRITICAL: Copy 'acquired_at' and 'cost_basis' from Lot Old
    
    Handler->>DB: INSERT INTO crypto_acquisition<br/>{asset: 'WETH', amount_initial: 1.0, amount_remaining: 1.0,<br/>kind: 'transformation', <br/>cost_basis: $500 (COPIED), acquired_at: '2022-01-01' (COPIED)...}
    
    DB-->>Handler: Success
    Handler-->>UI: Success
    
    UI->>User: Toast "Wrapped 1.0 ETH to WETH (Tax Neutral)"
